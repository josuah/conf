#!/bin/sh -eu

rel=8013.d9e940a768d1
iso=/var/iso/9front.$rel.iso

tmp=$(mktemp -d)
trap='rm -rf "$tmp"'
trap "$trap" INT TERM EXIT HUP

# fetch the iso

if [ ! -f "$iso" ]; then
	transmission-cli -w "$tmp" \
	  "http://9front.org/iso/9front-$rel.386.iso.gz.torrent" &

	while [ ! -f "$tmp/9front-$rel.386.iso.gz" ]; do
		sleep 1
	done

	gzip -cd "$tmp/9front-$rel.386.iso.gz" >$iso
fi

# headless install

put() {
	time=$1; shift 1

	echo "$*" | fold -w 1 | while IFS= read -r c; do
		printf %s "$c"
		sleep 0.1
	done
	printf '\r\n'
	sleep "$time"
}

{
	put  0.5
	put  0.5
	put  0.5
	put  0.5
	put  0.5
	put  0.5

	put  1 console=0 b19200 po
	put 30 boot

	put  1
	put  3 glenda
	put 11 text

	put  3 inst/start

	put  1 configfs
	put  5 hjfs

	put  1 partdisk
	put  3 sdC0
	put  1 mbr
	put  1 w
	put  4 q

	put  1 prepdisk
	put  1
	put  1 mbr
	put  1 w
	put  3 q

	put  1 mountfs
	put  1
	put  1
	put  10 yes

	put  1 configdist
	put  3 local

	put  1 mountdist
	put  1 /
	put  3 /

	put  1 tzsetup
	put  5 CET

	put $((10 * 60)) copydist # we are doing soup, let it cook

	put  1 bootsetup
	put  1
	put  1 yes
	put  3 yes

	put  1 finish
} | qemu install 9front "$iso" -nographic -no-reboot
