#!/bin/sh -eu

: ${rel:=8013.d9e940a768d1}
: ${iso:=/var/iso/9front.$rel.iso}
: ${disk:=/var/vm/9front.qcow}
: ${drawterm:=https://code.9front.org/hg/drawterm/archive/tip.tar.gz}

## usage:
case " $(uname) $* " in

##  9vm download -- download the 9front.iso with transmission

(" "*" download ")
	tmp=$(mktemp -d)
	trap 'rm -rf "$tmp"' INT TERM EXIT HUP
	if [ ! -f "$iso" ]; then
		transmission-cli -w "$tmp" \
		  "http://9front.org/iso/9front-$rel.386.iso.gz.torrent" &
		while [ ! -f "$tmp/9front-$rel.386.iso.gz" ]; do
			sleep 1
		done
		gzip -cd "$tmp/9front-$rel.386.iso.gz" >$iso
	fi
	;;

##  9vm drawterm -- install drawterm from source

(" "*" drawterm ")
	if type drawterm 2>/dev/null; then
		exec echo "drawterm already installed" >&2
	fi
	tmp=$(mktemp -d)
	trap 'rm -rf "$tmp"' INT TERM EXIT HUP
	cd "$tmp"
	curl -L "$drawterm" | gzip -cd | tar -xf -
	cd */
	make CONF="$(uname | tr A-Z a-z)"
	mkdir -p /usr/local/bin
	cp drawterm /usr/local/bin
	;;

##  9vm mac [addr] -- generate or get MAC address

(" "*" mac ")
	[ -f /var/vm/9front.mac ] || openssl rand -hex 5 \
	 | sed -r 's/(..)/:\1/g; s/^/ae/' >/var/vm/9front.mac
	cat /var/vm/9front.mac
	;;

##  9vm start -- start the vm

(" OpenBSD start ")
	mkdir -p /etc/vm
	echo 'vm "9front" {
		memory 1G
		disable
		interface {
			switch "uplink"
			lladdr "'"$("$0" mac)"'"
		}
		#disk '"$iso"' format raw
		disk '"$disk"' format qcow2
	}' >/etc/vm/9front.conf
	vmctl load "/etc/vm/9front.conf"
	vmctl start 9front
	;;
(" "*" start ") 
	case $(uname) in
	(Linux) set -- -accel kvm ;;
	(NetBSD) set -- -accel hax ;;
	(*) set -- ;;
	esac
	qemu-system-x86_64 \
	  -name 9front \
	  -m 1G \
	  -drive file="$disk",media=disk \
	  -drive file="$iso",media=cdrom \
	  -boot order=cd \
	  -netdev tap,id=n0,script=no,mac="$("$0" mac)" \
	  -device virtio-net-pci,netdev=n0 \
	  -chardev socket,id=c0,path=/var/run/qemu/9front,server,nowait \
	  -serial chardev:c0 \
	  -nographic \
	  "$@" &
	sleep 0.2 # create the unix domain socket
	;;

##  9vm stop -- kill the vm

(" OpenBSD stop ")
	exec vmctl stop 9front
	;;
(" "*" stop ")
	exec pkill -f "qemu-system-.* -name 9front "
	;;

##  9vm status -- is the vm running?

(" OpenBSD status ")
	exec vmctl show 9front
	;;
(" "*" status ")
	exec pgrep -fa "qemu-system-.* -name 9front "
	;;

##  9vm shell -- interactive console

(" OpenBSD shell ")
	exec cu "/dev/$(vmctl show 9front | awk 'NR == 2 { print $6 }')"
	;;
(" "*" shell ")
	exec socat unix:/var/run/qemu/9front stdio
	;;

(*)
	sed -n 's,^## ,,p' "$0"
	exit 1
	;;
esac
