#!/bin/sh -eu

lib="${0%/*/*}/lib/adm"

. "$lib/cmd_build.sh"
. "$lib/cmd_golang.sh"
. "$lib/cmd_module.sh"
. "$lib/cmd_monitor.sh"
. "$lib/cmd_repo.sh"

log() {
	echo "$1" >&2
}

check_package_manager() {
	if type "$1" >/dev/null; then
		exec echo "$2"
	fi
}

get_os() {
	kernel=$(uname)

	case $kernel in
	(Linux)
		check_package_manager	apt		DebianLinux
		check_package_manager	apk		AlpineLinux
		check_package_manager	pacman		ArchLinux
		check_package_manager	yum		RedHatLinux
		check_package_manager	zypper		SuseLinux
		check_package_manager	emerge		GentooLinux
		check_package_manager	xbps-install	VoidLinux
		;;
	(*)
		exec echo "$kernel"
		;;
	esac
}

trap_add() {
	trap="${trap:-:}; $1"
	trap "$trap" INT TERM EXIT HUP
}

trap_pop() {
	trap="${trap%; *}"
	trap "$trap" INT TERM EXIT HUP
}

run() {
	local command="$1" type="$2" name="$3"
	shift 3

	for x in "$@"; do
		if [ "${x%%=*}" = "os_$os" ]; then
			export "var_this_os=${x#*=}"
		fi
		export "var_$x"
	done

	echo ">>> $type/$name $*" >&2
	"$command" "$name" "$@"
}

apply() {
	local command="$1" node="$2" vars exit
	shift 2

	local vars
	while read node vars; do
		local type=${node%%/*}
		local name=${node#*/}

		if type "cmd_${type}_${command}" >/dev/null; then
			(run cmd_${type}_${command} "$type" "$name" $vars) ||
			  exit=1
		fi
	done

	return "${exit:-0}"
}

list() {
	local level="$1" node="$2"
	shift 2

	printf "%-$((level * 2))s%s" "" "$node"
	printf ' %s' "$@"
	printf '\n'

	[ -f "$etc/def/$node" ] || return 0

	while read node vars; do
		list $((level + 1)) "$node" "$@" $vars
	done <$etc/def/$node
}

main() {
	local command="$1"
	shift

	export PATH=/bin:/sbin:/usr/bin:/usr/sbin
	for x in adm /usr/*/bin /usr/*/sbin; do
		[ -d "$x" ] && export PATH="$PATH:$x"
	done

	export host="$(hostname | sed 's/[.].*//')"
	export os="$(get_os)"
	export tmp="$(mktemp -d)"
	export etc="${ADM_CONFIG:-/etc/adm}"
	export usr="${ADM_PREFIX:-/usr/adm}"
	export cache="${ADM_CACHE:-/var/cache/adm}"

	trap_add 'rm -rf "$tmp"'

	local i=$#
	while [ $i -gt 0 ]; do i=$((i - 1))
		case $1 in
		(*=*) set -- "$@" "$1" ;;
		(*/*) local node="$1" ;;
		(*) exec "$0" usage ;;
		esac
		shift
	done
	: ${node:=host/$host}

	local value
	for x in "$etc/data/sys/host/$host/"*; do x=${x##*/}
		[ -f "$etc/data/sys/host/$host/$x" ] || continue
		read -r value <$etc/data/sys/host/$host/$x
		set -- "$@" "$x=$value"
	done

	if [ -f "$lib/os_$os.sh" ]; then
		. "$lib/os_$os.sh"
	fi

	case $command in
	(install | update | enable | disable | start | stop | restart | reload | status | monitor)
		list 0 "$node" "$@" | apply "$command" "$node"
		;;
	(list)
		list 0 "$node" "$@"
		;;
	(*)
		echo "usage: ${0##*/} command [type/name] [key=value...]"
		echo "command: list, install, update, enable, disable, start, stop, restart, reload, status, monitor"
		;;
	esac
}

main "${@:-help}"
