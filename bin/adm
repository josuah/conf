#!/bin/sh -eu

send() { set -eu
	ssh "root@$host" "
		export PATH=/bin:/sbin:/usr/bin:/usr/sbin:\$(echo /usr/*/sbin /usr/*/bin | tr ' ' :)
		$*
	" </dev/null
}

cmd() { set -eu
	local type="$1" cmd="$2" name="$3" vars="$4"

	echo "-- $cmd $type/$name" $vars
	IFS='
'
	for x in $(echo "$vars" | xargs -n 1); do
		if [ "${x%%=*}" = "os_$os" ]; then
			export "var_this_os=${x#*=}"
		fi
		export "var_$x"
	done
	unset IFS

	"cmd_${type}_${cmd}" "$name"
}

apply() { set -eu
	local cmd="$1" type name vars exit=0

	while IFS=" /" read -r type name vars; do
		if type "cmd_${type}_${cmd}" >/dev/null; then
			if ! (cmd "$type" "$cmd" "$name" "$vars"); then
				echo error
				exit=1
			fi
		fi
	done
	return "$exit"
}

cmd="${1:-help}"
host="${2:-$(hostname -s)}"
case $# in (0) ;; (1) shift 1 ;; (*) shift 2 ;; esac

export PATH="/bin:/sbin:/usr/bin:/usr/sbin:$(echo /usr/*/sbin /usr/*/bin | tr ' ' :)"
export etc="${ADM_CONFIG:-/etc/adm}"
export lib="$etc/lib"
export db="$etc/db"
export usr="${ADM_PREFIX:-/usr/adm}"
export cache="${ADM_CACHE:-/var/cache/adm}"
export os="$(adm-db "$etc/host/$host/db" get os)"
export tmp="$(mktemp -d)"
trap 'rm -rf "$tmp"' INT TERM EXIT HUP

case $cmd in
(list)
	(cd "$etc"; adm-db "host/$host/db" tree)
	;;
(install | update | uninstall | start | stop | restart | reload | status)
	. "$etc/lib/cmd_pkg.sh"
	. "$etc/lib/cmd_mod.sh"
	. "$etc/lib/cmd_golang.sh"
	. "$etc/lib/cmd_repo.sh"
	. "$etc/lib/cmd_exec.sh"
	. "$etc/lib/os_$os.sh"
	(cd "$etc"; adm-db "host/$host/db" tree) | apply "$cmd"
	;;
(*)
	echo "usage: ${0##*/} cmd [host] [key=value...]"
	echo "list, install, update, uninstall, start, stop, restart, reload, status"
	;;
esac
