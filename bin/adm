#!/bin/sh -eu

send() { set -eu
	ssh "${user:-root}@$host" "
		export PATH='/bin:/sbin:/usr/bin:/usr/sbin'
		export PATH=\"\$PATH\$(printf :%s /usr/*/sbin /usr/*/bin)\"
		set -eu
		$1
	"
}

apply() { set -eu
	export "$@" this="$(awk 'BEGIN { print ENVIRON[ENVIRON["os"]] }')"
	if type "cmd_${add}_${do}" >/dev/null; then
		echo "=>" "$@"
		"cmd_${add}_${do}" "${name:-}" </dev/null
	fi
}

export cmd="${1:-help}"
export host="${2:-$(hostname -s)}"
export etc="${ADM_CONFIG:-/etc/adm}"
export lib="$etc/lib"
export db="$etc/db"
export usr="${ADM_PREFIX:-/usr/adm}"
export cache="${ADM_CACHE:-/var/cache/adm}"
export os="$(dbase "$etc/host/$host/db" get os)"
export nl="
"

case $# in (0) ;; (1) shift 1 ;; (*) shift 2 ;; esac

case $cmd in
(list)
	(cd "$etc"; dbase "host/$host/db" tree)
	;;
(install | update | uninstall | start | stop | restart | reload | status)
	. "$etc/lib/cmd_pkg.sh"
	. "$etc/lib/cmd_mod.sh"
	. "$etc/lib/cmd_golang.sh"
	. "$etc/lib/cmd_repo.sh"
	. "$etc/lib/cmd_exec.sh"
	. "$etc/lib/os_$os.sh"

	IFS="$nl"
	for line in $(cd "$etc"; dbase "host/$host/db" tree); do
		if ! (apply do="$cmd" $(echo "$line" | xargs -n 1)); then
			exit=1
			echo error
		fi
	done
	exit "${exit:-0}"
	;;
(*)
	echo "usage: ${0##*/} command [host] [key=value...]"
	echo "command: list, install, update, uninstall, start, stop, restart, reload, status"
	;;
esac
