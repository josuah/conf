#!/bin/sh -eu

etc=${ADM_CONFIG:-/etc/adm}

write() {
	local dir="$1" now="$2"
	shift 2

	if [ "$(stat -f %z "$dir/current")" -gt $((128 * 1024 * 1024)) ]; then
		mv "$dir/current" "$dir/$now.tmp"
		{
			gzip <"$dir/$now.tmp" >"$dir/$now.gz"
			rm -f "$dir/$now.tmp"
		} &
	fi
	echo "$now" "$*" >>$dir/current
}

for host in "$etc/var/sys/host/"*; do
	test -f "$host" || continue

	host=${host##*/}

	printf '%-15s ' "$host" >&2
	adm monitor "host/$host" |
	while read result; do
		printf '.'
		now=$(date +%s)
		dir=/var/spool/adm/monit/$host
		mkdir -p "$dir"
		write "$dir" "$now" $result
	done
	printf '\n'
done
