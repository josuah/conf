#!/bin/sh -eu

ref=${1:-master}
dest=/var/lib/adm

archive=archive-$(date +%s)-$(git rev-parse "$ref")-$ref
git fetch "$ref"

for host in $(adm-db db/node/host get host | sort -u); do
	[ -f "$host" ] || continue
	host=${host#node/host/}
	git archive --prefix="/var/lib/adm/$archive" | ssh "$host" "
		tar -xf -
		ln -s '$archive' '$archive/current'
		mv '$archive/current' '/var/lib/adm'
		cd '$archive/current'
		sh -eux update.sh
	"
done
