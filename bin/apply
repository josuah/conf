#!/bin/sh -eu

mod=${1:?}
base=$(cd "$(dirname "$0")/.."; pwd)
db=$base/db
dest=/etc/$mod
tmp=$(mktemp)
bin=$base/bin
trap 'rm -rf "$tmp"' INT TERM EXIT HUP

copy() {
	local copy=${1:?}
	mkdir -p "$dest"
	cp -rf "$copy" "$dest"
}

conf() {
	local conf=${1:?}
	"$bin/template" "$db" "$conf.in" >$tmp
	mv "$tmp" "$conf"
}

pass() {
	dd if=/dev/urandom bs=32 count=1 2>/dev/null | od -x -A n | tr -cd '0-9a-f' >$tmp
	mv "$tmp" "${1:?}"
}

cd "mod/$mod"
. ./mod.sh
