#!/bin/sh -eu

apply=${1:-deploy}

export base=$(cd $(dirname "$0")/..; pwd)
export tmp=$(mktemp)
export host=host/$(hostname -s)
export exit=0

trap 'rm -rf "$tmp"' INT TERM EXIT HUP

o() {
	"$base/bin/do-$apply" "$@"
}

module() {
	local module=${1:?}
	export dest=/etc/${module#module/}

	echo >&2 ">>> $apply $module"
	(cd "$base/$module"; . ./mod; :) || {
		echo >&2 "failed"
		exit=1
	}
}

[ -f "$host" ] || { echo>&2 "$host does not exist"; exit 1; }

while read item; do
	case $item in
	(module/*)
		module "$item"
		;;
	(role/*)
		while read role; do
			module "$role"
		done <$item
		;;
	esac
done <$host

exit "$exit"
