#!/bin/sh -eu

die() {
	echo >&2 "error: $*"
	exit 1
}

o() {
	"$base/bin/do/$apply" "$@" "$arg"
}

module() {
	local item=${1:?} arg=${2:-}
	export etc=/etc/${item#module/}

	if (cd "$base/$item"; . ./def; :) >&2; then
		echo "ok $apply $item"
	else
		echo "err $apply $item"
		exit=1
	fi
}

resolve() {
	local item=${1:?}
	shift

	case $item in
	(module/*)
		module "$item" "$@"
		;;
	(*/*)
		while read item; do
			resolve "$item" "$@"
		done <$item
		;;
	(*)
		die "unknown type: $item"
		;;
	esac
}

export apply=${1:?}
export apply=${apply##*/}
export base=$(cd $(dirname "$0")/..; pwd)
export tmp=$(mktemp)
export host=${host:-$(hostname -s)}
export exit=0
shift 1

trap 'rm -rf "$tmp"' INT TERM EXIT HUP
[ -x "$base/bin/do/$apply" ] || die "unknown script $base/bin/do/$apply"
resolve "host/$host/modules" "$@"
exit "$exit"
