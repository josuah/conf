#!/bin/sh -eu

command=${1:?}
root=${2:-host/$(hostname -s)}
[ $# = 1 ] && shift 1 || shift 2

base=$(cd "${0%/*}/.."; pwd)

while read node args; do
	if [ -f "$base/bin/do-${node%/*}" ]; then
		echo >&2 "$node"
		"$base/bin/do-${node%/*}" "$command" "$node" $args || exit=1
	fi
done <<EOF
$($base/bin/list "$root" "$@")
EOF

exit "${exit:-0}"
