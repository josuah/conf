#!/bin/sh -eu

list() {
	ls -d "$1".* | sed -rn 's,.*\.v([0-9]+),\1,p' | sort -n
}

cur=$(readlink "$1" 2>/dev/null | sed -n 's,.*\.v,,p')

case "$# $* " in
(3" "*" init "*" ") path=$1 url=$3
	git clone --mirror "$url" "$path.git"
	git -C "$path.git" config tar.umask 002
	;;
(1" "*" ") path=$1
	exec "$0" "$path" pull "master"
	;;
(3" "*" pull "*" ") path=$1 ref=$3
	v=$(($(list "$path" | sed -n '$p') + 1))
	new=$(basename "$path").v$v
	dir=$(dirname "$path")

	git -C "$path.git" fetch origin "$ref"
	git -C "$path.git" archive --prefix "$new/" "$ref" | tar -C "$dir" -xf -

	if type stagit >/dev/null; then
		(cd "$path.git"; stagit .; ln -sf files.html index.html)
	fi

	if [ -f "$dir/$new/Makefile" ]; then
		make -C "$dir/$new" deploy
	fi

	"$0" "$path" clean
	"$0" "$path" link "$v"
	;;
([23]" "*" clean "*) path=$1 keep=${3:-3}
	list "$path" | awk -v cur="$cur" -v path="$path" -v keep="$keep" '
		$0 != cur { A[NR] = $0 }
		END { for (i = 1; i <= NR - keep; i++ ) print path ".v" A[i] }
	' | xargs -r rm -rf
	;;
(3" "*" link "*" ") path=$1 v=$3
	set -x
	tmp=$(mktemp -d)
	name=$(basename "$path")
	trap 'rm -rf "$tmp"' INT TERM EXIT HUP
	ln -fs "$name.v$v" "$tmp/$name"
	mv -f "$tmp/$name" "$(dirname "$path")"
	;;
(*)
	echo>&2 "usage:	${0##*/} <path> init <url> - initialize the repository"
	echo>&2 "	${0##*/} <path>            - ${0##*/} <path> pull master"
	echo>&2 "	${0##*/} <path> pull <ref> - deploy new git object <ref>"
	echo>&2 "	${0##*/} <path> clean <n>  - keep only last <n> releases"
	echo>&2 "	${0##*/} <path> link <v>   - switch "current" to release <v>"
	exit 1
	;;
esac
