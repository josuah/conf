#!/bin/sh -eu

zone=$2
soa=$(awk '$1 == "$ORIGIN" { sub(/\.$/,"", $2); print $2 }' "$zone")

case "$*" in
("zsk "*)
	mkdir -p -m 700 "/etc/dnssec/$soa+zsk"
	cd "/etc/dnssec/$soa+zsk"
	ldns-keygen -a ECDSAP256SHA256 -b 4096 -r /dev/urandom "$soa" >>log
	;;
("ksk "*)
	mkdir -p -m 700 "/etc/dnssec/$soa+ksk"
	cd "/etc/dnssec/$soa+ksk"
	ldns-keygen -k -a ECDSAP256SHA256 -b 4096 -r /dev/urandom "$soa" >>log
	;;
("sign "*)
	zsk=/etc/dnssec/$soa+zsk/$(tail -n 1 /etc/dnssec/$soa+zsk/log)
	ksk=/etc/dnssec/$soa+ksk/$(tail -n 1 /etc/dnssec/$soa+ksk/log)
	salt=$(openssl rand -hex 64)
	ldns-signzone -n -s "$salt" "$zone" "$ksk" "$zsk" >$zone.signed
	echo "ksk=${ksk##*/}" "zsk=${zsk##*/}"
	;;
("sshfp "*)
	awk '/[ \t](A|AAAA)[ \t]/ && !uniq[$1]++ { print $1 }' "$zone" \
	 | sort | xargs ssh-keyscan -D
	;;
(*)
	echo "usage: ${0##*/} (ksk|zsk|sign) zonefile" >&2
	exit 1
	;;
esac
