#!/bin/sh -eu

command=${1:?}
shift

case $command in
(package)
	"$base/bin/os/package" install "$@"
	;;
(service)
	"$base/bin/os/service" enable "$@"
	;;
(file)
	for copy; do
		mkdir -p "$etc"
		cp -rf "$copy" "$etc"
	done
	;;
(conf)
	conf=${1:?}

	(cd "$base/db"; "$base/bin/template" >$tmp) <$conf.in
	mkdir -p "$(dirname "$etc/$conf")"
	mv "$tmp" "$etc/$conf"
	;;
(pass)
	for pass; do
		cd "$base/db"
		[ -d "$pass/pass" ] && continue
		dd if=/dev/urandom bs=32 count=1 2>/dev/null \
		| od -x -A n | tr -cd '0-9a-f' >$tmp
		mkdir -p "$pass"
		mv "$tmp" "$pass/pass"
	done
	;;
(repo)
	repo=${1:?} path=${2:?}

	if [ -d "$path" ]; then
		git -C "$path" fetch --all
	else
		git clone --depth 1 "$repo" "$path"
	fi
	;;
(run)
	exit 1
	;;
esac
