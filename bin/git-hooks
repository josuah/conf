#!/bin/sh -e
export PATH="/bin:/sbin:/usr/bin:/usr/sbin$(printf :%s /usr/*/bin /usr/*/sbin)"

logger -s -p daemon.notice -t "git-hooks" "running $0 $*"

case "$# $* " in
(1" install ")
	ln -sf "$0" hooks/post-update
	;;
(2" workdir "*" ") ref=$2
	commit=$(git rev-parse "$ref")
	workdir="/var/cache/git/workdir/$commit"
	mkdir -p "$workdir"
	trap 'rm -rf "$workdir"' INT EXIT TERM HUP
	git archive --prefix="${workdir#/}/" --format="tar" "$ref" | (cd / && tar -xf -)
	exec echo "$workdir"
	;;
(1" refs/heads/"*" ") ref=$1
	git cat-file blob "$ref:.git$0" | sed 's/#!//' | {
		read -r cmd arg
		exec "$cmd" "$arg" /dev/stdin "$ref"
	}
	;;
(*)
	echo>&2 "usage:	git hooks install		-- enable hooks in current directory"
	echo>&2 "	git hooks run <name> <ref>	-- run hook <name> for object <ref>"
	echo>&2 "	git hooks workdir <ref>		-- extract <ref> in $tmp printed out"
	exit 1
	;;
esac
