#!/bin/sh -eu
export PATH="/bin:/sbin:/usr/bin:/usr/sbin$(printf :%s /usr/*/bin /usr/*/sbin)"
export GITDIR="$PWD"
export GITNAME="${PWD##*/}"

logger -s -p daemon.notice -t "git-hooks" "running $0 $*"

case "$# $* " in
(1" install ")
	ln -sf "$0" hooks/post-update
	;;
(2" workdir "*" ") ref=$2
	commit=$(git rev-parse "$ref")
	workdir="/var/cache/git/workdir/$commit"
	mkdir -p "$workdir"
	trap 'rm -rf "$workdir"' INT EXIT TERM HUP
	git archive --prefix="${workdir#/}/" --format="tar" "$ref" | (cd / && tar -xf -)
	exec echo "$workdir"
	;;
(1" refs/heads/"*" ") ref=$1
	set +e
	"$0" run stagit
	"$0" run stagit-gopher
	"$0" run make-dist
	;;
(2" run stagit ")
	git cat-file blob master:.gitdescription >description
	type stagit || exit 0
	mkdir -p  "/var/www/htdocs/git/$GITNAME"
	cd "/var/www/htdocs/git/$GITNAME"
	stagit -c stagit-cache "$GITDIR"
	repos=$(ls /git/*/git-daemon-export-ok | sed 's,/[^/]*$,,')
	stagit-index $repos >/var/www/htdocs/git/index.html
	;;
(2" run stagit-gopher ")
	git cat-file blob master:.gitdescription >description
	type stagit-gopher || exit 0
	mkdir -p  "/var/gopher/git/$GITNAME"
	cd "/var/gopher/git/$GITNAME"
	stagit-gopher -c stagit-gopher-cache "$GITDIR"
	repos=$(ls /git/*/git-daemon-export-ok | sed 's,/[^/]*$,,')
	stagit-gopher-index $repos >/var/gopher/git/index.gph
	;;
(2" run make-dist ") ref=$1
	for v in $(git tag); do
		export tmp=$(exec "$0" workdir "$v")
		trap 'rm -rf "$tmp"' INT TERM EXIT HUP
		cd "$tmp"
		make dist
		mkdir -p /var/gopher/dl /var/www/htdocs/dl
		cp *.gz /var/gopher/dl
		cp *.gz /var/www/htdocs/dl
		rm -rf "$tmp"
	done
	;;
(*)
	echo>&2 "usage:	git hooks install		-- enable hooks in current directory"
	echo>&2 "	git hooks run <hook>		-- run built-in hook"
	echo>&2 "	git hooks workdir <ref>		-- extract <ref> in $tmp printed out"
	exit 1
	;;
esac
