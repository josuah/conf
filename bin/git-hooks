#!/bin/sh -eu
export PATH="/bin:/sbin:/usr/bin:/usr/sbin$(printf :%s /usr/*/bin /usr/*/sbin)"
export GITDIR="$PWD"
export GITNAME="${PWD##*/}"

logger -s -p daemon.notice -t "git-hooks" "$0 $*"

case "$# $* " in
(1" install ")
	ln -sf "$0" hooks/post-update
	;;
(1" refs/heads/"*" ") ref=$1
	! "$0" run stagit
	! "$0" run stagit-gopher
	git cat-file blob "$ref:.git$0" | sed 's/#!//' | {
		read -r cmd arg
		exec "$cmd" "$arg" /dev/stdin "$ref"
	}
	;;
(2" run stagit ")
	git cat-file blob master:.gitdescription >description
	type stagit || exit 0
	mkdir -p  "/var/www/htdocs/git/$GITNAME"
	cd "/var/www/htdocs/git/$GITNAME"
	stagit -c stagit-cache "$GITDIR"
	repos=$(ls /git/*/git-daemon-export-ok | sed 's,/[^/]*$,,')
	stagit-index $repos >/var/www/htdocs/git/index.html
	;;
(2" run stagit-gopher ")
	git cat-file blob master:.gitdescription >description
	type stagit-gopher || exit 0
	mkdir -p  "/var/gopher/git/$GITNAME"
	cd "/var/gopher/git/$GITNAME"
	stagit-gopher -c stagit-gopher-cache "$GITDIR"
	repos=$(ls /git/*/git-daemon-export-ok | sed 's,/[^/]*$,,')
	stagit-gopher-index $repos >/var/gopher/git/index.gph
	;;
(*)
	echo>&2 "usage:	git hooks install		-- enable hooks in current directory"
	echo>&2 "	git hooks run <hook>		-- run built-in hook"
	exit 1
	;;
esac
