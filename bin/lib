#!/bin/cat source this file

die() {
	echo >&2 "error: $*"
	exit 1
}

trap_add() {
	trap="$trap; $1"
	trap "$trap" INT TERM EXIT HUP
}

trap_pop() {
	trap="${trap%; *}"
	trap "$trap" INT TERM EXIT HUP
}

command=${1:?}
name=${2:?}
shift 2

name=${name%/}
name=${name#def/}
name=${name#*/}

trap=:

tmp=$(mktemp -d)
trap_add 'rm -rf "$tmp"'

host=${host:-$(hostname -s)}
base=$(cd "${0%/*}/.."; pwd)

export PATH=/bin:/sbin:/usr/bin:/usr/sbin
for path in adm /usr/*/bin /usr/*/sbin; do
	[ ! -d "$path" ] || export PATH="$PATH:$path"
done

all_vars=

for path in "$base/var/sys/host/$host/"*; do
	var=${path##*/}
	case $var in ( "*" ) continue ;; esac
	read value <$path

	export "var_$var=$value"
	all_vars="$all_vars $var=$value"
done

for var in "$@"; do
	export "var_$var"
	all_vars="$all_vars $var"
done
