#!/bin/sh -eu

# This part of monitower reads a single log file as input, and for every line,
# split it as key=values format, and trigger the "$check" for "$host" and store it
# as "$host/$name" in the spool directory.
#
# This way, as few as possible is performed every time, and no complex configuration
# parsing and exploitation is made at every run, and this script is inexpensive enough
# to be run from a /etc/crontab.

check() { set -u +e
	local exit line now="$(date +%s)"
	for x; do local "var_$x"; done

	mkdir -p "$spool/$var_host/$var_name"
	out=$("check-$var_check" "$@" 2>&1)
	exit=$?

	line="time=$now exit=$exit"
	echo "$line" >>$spool/$var_host/$var_name/current
	[ "$exit" = 0 ] || echo "$out" | monitower-event $line "$@"
}

spool=/var/spool/monitower
IFS='
'
sed -r 's,\\\\,\\s,g; s,\\",\\q,g' "$@" \
| while IFS=' ' read line; do
	sleep $((RANDOM % 30)) && check $(echo $line | xargs -n 1) &
done
