#!/bin/sh -eu

pack=$1

pack_download_git() {
	git clone --depth 1 --branch "$ver" "$url" "$SOURCE"
	rm -rf "$SOURCE/.git"
}

pack_download_tar() {
	curl -L "$url" | tar -xzf-
}

pack_download() {
	case $url in
	(*.tgz|*.tar.gz) pack_download_tar ;;
	(git://*|*.git) pack_download_git ;;
	(*) echo url error >&2; exit 1 ;;
	esac
}

pack_configure() {
	if [ -f autogen.sh -a ! -f configure ]; then
		./autogen.sh
	fi
	if [ -f configure -a ! -f Makefile ]; then
		./configure --prefix="$PREFIX"
	fi
}

pack_build() {
	if [ -f Makefile ]; then
		make
	fi
}

pack_install() {
	make PREFIX="$PREFIX" install
}

. "recipe/$pack.sh"

export SOURCE="$PWD/source/$pack-$ver"
trap 'rm -rf "$SOURCE"' INT TERM EXIT HUP

if [ ! -d "$SOURCE" ]; then
	mkdir -p -m 755 source
	(cd source && pack_download)
fi

export PREFIX="$PWD/build/$pack-$ver"
trap 'rm -rf "$PREFIX"' INT TERM EXIT HUP

if [ ! -d "$PREFIX" ]; then
	mkdir -p -m 755  "$PREFIX"
	(set +u; cd "$SOURCE" && pack_configure)
	(set +u; cd "$SOURCE" && pack_build)
	(set +u; cd "$SOURCE" && pack_install)
fi

exec echo "built $pack in $PREFIX"
