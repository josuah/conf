#!/bin/sh -eu

pack=$1

pack_download() {
	case $url in
	(*.tgz|*.tar.gz)
		curl "$url" | tar -xzf-
		;;
	(git://*|*.git)
		git clone --depth 1 --branch "$ver" "$url" "$pack-$ver"
		rm -rf "$pack-$ver/.git"
		;;
	esac
}

pack_configure() {
	if [ -f configure ]; then
		./configure --prefix="$PREFIX"
	fi
}

pack_build() {
	if [ -f Makefile ]; then
		make
	fi
}

pack_install() {
	make PREFIX="$PREFIX" install
}

. "recipe/$pack.sh"


export SOURCE="$PWD/source/$pack-$ver"
trap 'rm -rf "$SOURCE"' INT TERM EXIT HUP

if [ ! -d "$SOURCE" ]; then
	mkdir -p -m 755 source
	(cd source && pack_download)
fi

export PREFIX="$PWD/build/$pack-$ver"
trap 'rm -rf "$PREFIX"' INT TERM EXIT HUP

if [ ! -d "$PREFIX" ]; then
	mkdir -p -m 755  "build/$pack-$ver"
	(cd "$SOURCE" && pack_configure)
	(cd "$SOURCE" && pack_build)
	(cd "$SOURCE" && pack_install)
fi

exec echo "built $pack in $PWD/build/$pack-$ver"
