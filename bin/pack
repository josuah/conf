#!/bin/sh -eu

pack=$1

pack_download() {
	case $url in
	(*.tgz|*.tar.gz)
		curl "$url" | tar -xzf-
		;;
	(git://*|*.git)
		git clone --depth 1 --branch "$ver" "$url" "$pack-$ver"
		rm -rf "$pack-$ver/.git"
		;;
	esac
}

pack_configure() {
	if [ -f configure ]; then
		./configure --prefix="$PREFIX"
	fi
}

pack_build() {
	if [ -f Makefile ]; then
		make
	fi
}

pack_install() {
	trap 'rm -rf "$PREFIX"'
	make PREFIX="$PREFIX" install
}

. "recipe/$pack.sh"

export PREFIX="$PWD/build/$pack-$ver"

mkdir -p -m 755 source
if [ ! -d "source/$pack-$ver" ]; then
	(cd source && pack_download)
fi

trap "rm -rf '$PWD/build/$pack'" INT TERM EXIT HUP
if [ ! -d "build/$pack-$ver" ]; then
	mkdir -p -m 755  "build/$pack-$ver"
	(cd source/$pack-$ver && pack_configure)
	(cd source/$pack-$ver && pack_build)
	(cd source/$pack-$ver && pack_install)
fi

exec echo "built $pack in $PWD/build/$pack-$ver"
