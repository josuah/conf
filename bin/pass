#!/bin/sh -eu

: ${PASSWORD_STORE_DIR:=$HOME/.password-store}
: ${PASSWORD_STORE_GENERATED_LENGTH:-32}

umask "${PASSWORD_STORE_UMASK:-077}"

case " $* " in
(" init ")
	mkdir -p "$PASSWORD_STORE_DIR"
	;;
(" ls "*)
	(cd "$PASSWORD_STORE_DIR/${2:-}"; find *) | sed 's,[^/]*/,:  ,g'
	;;
(" find "*?" ")
	(cd "$PASSWORD_STORE_DIR"; find . -name "*$2*")
	;;
(" show "*?" ")
	cat "$PASSWORD_STORE_DIR/$2"
	;;
(" insert "*?" ")
	if [ -f "$PASSWORD_STORE_DIR/$2" ]; then
		echo "$PASSWORD_STORE_DIR/$2 already exist" 
	fi
	mkdir -p "$PASSWORD_STORE_DIR/${2%/*}"
	echo "$(exec "$0" new)" >$PASSWORD_STORE_DIR/$2
	;;
(" edit "*?" ")
	${EDITOR:-vi} "$PASSWORD_STORE_DIR/$2"
	;;
(" generate "*?" ")
	n=${3:-PASSWORD_STORE_GENERATED_LENGTH}
	pass=$(openssl base64 -in /dev/urandom 2>/dev/null \
	| sed -r "y,+/,-_,; s,^,$(date +%y%m%d-),; s,(.{${3:-len}}).*,\1,; q")
	;;
(" version ")
	echo "pass-posix-sh"
	exit 1
	;;
("  ")
	sel=$(cd "$PASSWORD_STORE_DIR"; find * -type f | dmenu)
	echo "$sel" | sed 's,.*/,,' | tr -d '\n' | xsel -ib
	"$0" show "$sel" | tr -d '\n' | xsel -ip
	;;
(" "*" ")
	[ -f "$1" ] && exec "$0" show "$1"
	[ -d "$1" ] && exec "$0" ls "$1"
	echo "usage: pass (init ls find show insert edit generate version help)" >&2
	exit 1
	;;
esac
