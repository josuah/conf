#!/bin/sh -eu

key=$HOME/.ssh/id_ed25519

mkdir -p "$HOME/.password-store"
cd "$HOME/.password-store"

err() {
	echo "error: $1" >&2
	exit 2
}

case ${1:-} in
(get)
	exec age -d -i "$key" "$2"
	;;
(set)
	[ -e "$2" ] && err "password $2 already exist"
	mkdir -p "${2%/*}"
	exec age -a -r "$(cat "$key.pub")" >$2
	;;
(export)
	for x in */*; do
		"$0" get "$x" | awk -v id="$x" '{ print id, $0 }'
	done
	;;
(import)
	while read id pass; do
		echo "$pass" | "$0" set "$id"
	done
	;;
("")
	file=$(find * -type f | dmenu -fn terminus:pixelsize=16 -p pass)
	"$0" get "$file" | tr -d '\n' | xsel -i
	echo "${file##*/}" | tr -d '\n' | xsel -bi
	;;
(*)
	exec >&2
	echo "usage: ${0##*/} (set|get) resource/account-name"
	echo "       ${0##*/}"
	;;
esac
