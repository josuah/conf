#!/bin/sh -eu

disk=/var/disk/${2:-}.qcow

case " $* " in
(" install "*" "*" "*) name=$2 iso=$3; shift 3

	if [ ! -f "$disk" ]; then
		qemu-img create -f qcow2 "$disk" 8G
	fi

	exec "$0" run "$name" \
	  -drive file="$iso",media=cdrom \
	  -boot once=d \
	  "$@"
	;;
(" run "*" "***" ") name=$2; shift 2

	if pgrep -f "qemu-system-.* -drive file=$disk"; then
		exec echo "$name already running"
	fi

	umask 002
	mkdir -p /var/run/vnc
	! groupadd vnc 2>/dev/null
	chgrp vnc /var/run/vnc

	# -display vnc=unix:"/var/run/vnc/$name" \
	set -- qemu-system-x86_64 -m 1G 2>&1 \
	  -nic user,hostfwd=tcp::17019-:17019 \
	  -drive file="$disk",media=disk \
	  "$@"
	echo "$@" >&2
	exec "$@"
	;;
(*)
	echo>&2 "usage:	${0##*/} install <name> <iso> [qemu-args...]"
	echo>&2 "	${0##*/} run <name> [qemu-args...]"
	exit 1
	;;
esac
