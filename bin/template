#!/usr/bin/awk -f
# simple yet powerful templating engine leveraging sh(1)

function shell(cmd)
{
	if ("DEBUG" in ENVIRON) printf("%s", cmd)
	else printf("%s", cmd) | "exec sh -eu"
}

function enter(to, was)
{
	old = zone
	zone = to
	return to != old
}

NR == 1 {
	enter("code")
	shell("NOW=$(date +%Y-%m-%d)\n")
}

{
	if (sub(/^%% ?/, "")) {
		if (enter("code")) shell("'\n")
	} else {
		gsub(/'/, "'\\''")
		if (enter("text")) shell("echo -n '")
	}
	while (match($0, /\{\{[_0-9a-zA-Z]+\}\}/)) {
		shell(substr($0, 1, RSTART-1))
		shell("'\"$"substr($0, RSTART+2, RLENGTH-2-2)"\"'")
		$0 = substr($0, RSTART + RLENGTH)
	}
	shell($0"\n")
}

END {
	if (enter("code")) shell("'\n")
}
