#!/bin/sh -eu

tpl_interface='[Interface]
PrivateKey = %s
ListenPort = 51820
'

tpl_peer='[Peer]
PublicKey = %s
'

mkdir -p -m 700 /etc/wireguard

sec=$(openssl rand -base64 32)
if [ -f /etc/wireguard/interface.conf ]; then
	sec=$(awk '{sub(" *= *", " ")} tolower($1)=="privatekey" {print $2}' \
	  /etc/wireguard/interface.conf)
else
	sec=$(openssl rand -base64 32)
	printf "$tpl_interface" "$sec" >/etc/wireguard/interface.conf 
fi

case $(uname) in
(Linux)
	pub=$(echo "$sec" | wg pubkey)
	;;
(OpenBSD)
	trap 'ifconfig wg99999 destroy' INT TERM EXIT HUP
	ifconfig wg99999 create wgport 51820 wgkey "$sec"
	pub=$(ifconfig wg99999 | awk '$1 == "wgpubkey" { print $2 }')
	;;
esac

cp /etc/wireguard/interface.conf /etc/wireguard/wg0.conf
for peer in "$@"; do
	[ "${peer##*/}" = "$(hostname -s)" ] && continue
	echo
	cat "$peer"
done >>/etc/wireguard/wg0.conf

printf "$tpl_peer" "$pub"
