#!/bin/sh -eu

openssl_cnf='

[req]
default_bits			= 4096
default_md			= sha256
req_extensions			= req_extensions
distinguished_name		= req_distinguished_name

[req_distinguished_name]
commonName			= CommonName

[ca]
default_ca			= ca_default

[ca_default]
default_md			= sha256
default_days			= 65535
default_crl_days		= 1
policy				= ca_policy

[ca_policy]
countryName			= optional
stateOrProvinceName		= optional
localityName			= optional
organizationName		= optional
organizationalUnitName		= optional
commonName			= supplied
emailAddress			= optional

' # end

openssl_ca='

[req_extensions]
basicConstraints		= critical,CA:true,pathlen:1
keyUsage			= digitalSignature,keyCertSign,cRLSign

' # end

openssl_cert='

[req_extensions]
keyUsage			= digitalSignature,keyCertSign,cRLSign
nsCertType			= server,client
extendedKeyUsage		= serverAuth,clientAuth

' # end

case " $* " in
(" ca "*?" create ")
	ca=${2:?}

	mkdir -p "/etc/ssl/ca/$ca/private"
	cd "/etc/ssl/ca/$ca"
	chmod 700 private

	echo "$openssl_cnf $openssl_ca" |
	openssl req -config /dev/stdin -x509 -newkey rsa:4096 -nodes \
	  -keyout private/ca.key -out ca.crt -subj "/CN=$ca"
	;;
(" ca "*?" delete ")
	rm -r "/etc/ssl/$2/"
	;;
(" csr "*?" ")
	cn=$2

	mkdir -p /etc/ssl/private
	cd /etc/ssl

	echo "$openssl_cnf $openssl_cert subjectAltName=DNS:$cn" |
	openssl req -config /dev/stdin -x509 -newkey rsa:4096 -nodes \
	  -keyout "private/$cn.key" -out "$cn.csr" -subj "/CN=$cn"
	;;
(" ca "*?" sign "*?" ")
	ca=$2 cn=$4

	cd /etc/ssl

	echo "$openssl_cnf $openssl_cert" |
	openssl ca -config /dev/stdin -notext -in "$cn.csr" -out "$cn.crt" \
	  -keyfile "ca/$ca/private/ca.key" -cert "ca/$ca/ca.crt"

	cat "$ca/ca.crt" >>$cn.crt

	chmod 444 "$cn.crt"
	;;
(" dhparam ")
	if [ ! -f "dhparam.pem" ]; then
		openssl dhparam -out /etc/ssl/dhparam.pem 2048
	fi
	;;
(*)
	echo>&2	"usage:	${0##*/} ca <name> create"
	echo>&2	"	${0##*/} ca <name> delete"
	echo>&2	"	${0##*/} dhparam"
	echo>&2	"	${0##*/} csr <name>"
	echo>&2	"	${0##*/} ca <name> sign <csr>"
	;;
esac
