#!/bin/sh -eu

export DISPLAY="${DISPLAY:-:0}"

url=$(echo "$1" | sed 's,#.*,,; s,/*$,,')
hash=$(echo "$url" | openssl sha256 | sed 's/(stdin)= //')
file=${XDG_CACHE_HOME:-$HOME/.cache}/hash/$hash-${url##*/}

case "$(echo "$url" | tr A-Z a-z)" in
(*://invidio.us/*|*://*youtube.com/*|*://youtu.be/*|*://*dailymotion.com/*\
|*://vimeo.com/*|*://*bandcamp.com/track/*)
	exec mpv "$url"
	;;
(*://github.com/*/*|http*://*.git|git*://*)
	mkdir -p "$HOME/src"
	exec git clone "$url"
	;;
(*.jpg|*.jpeg|*.png|*.gif)
	curl -o "$file" "$url"
	sxiv "$file"
	;;
(*.pdf|*.ps)
	curl -o "$file" "$url"
	exec mupdf "$file"
	;;
(*.mkv|*.webm|*.avi|*.mp4)
	exec ffplay "$url"
	;;
(*.mka|*.ogg|*.opus|*.mp3|*.flac|*.wav)
	exec ffplay "$url"
	;;
(*.txt|*.md|*.sh|*.c)
	curl -o "$file"
	exec x-terminal-emulator less "$file"
	;;
(magnet:*|*.torrent)
	exec transmission-remote -a "$url"
	;;
(ssh://*)
	exec x-terminal-emulator ssh "$url"
	;;
(sftp://*/*)
	scp "$url" "$file"
	exec xdg-open "$file"
	;;
(sftp://*)
	exec x-terminal-emulator sftp "$url"
	;;
(ftp://*)
	exec x-terminal-emulator ftp "$url"
	;;
(gopher://)
	exec x-terminal-emulator sacc "$url"
	;;
(http*://*)
	exec x-www-browser "$url"
	;;
(mumble://*)
	exec mumble "$url"
	;;
(*)
	echo "no handler for $url" >&2
	exit 1
esac
