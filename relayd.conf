# deployed on 2021-05-15

include "/etc/macros.conf"

prefork 5
log connection

table <"gopher"> { ams1 }
table <"http"> { ams1 }
table <"gemini"> { ams1 }

protocol "tls" {
	include "/etc/relayd/tls.conf"
}

http protocol "http" {
	match request header append "X-Forwarded-For" value "$REMOTE_ADDR"
	match request header append "X-Forwarded-By" value "$SERVER_ADDR:$SERVER_PORT"
	include "/etc/relayd/tls.conf"
}

relay "http" {
	listen on egress port 80
	protocol "http"
	forward to 127.0.0.1 port 80 check tcp
}

relay "https" {
	listen on egress port 443 tls
	protocol "http"
	forward to <"http"> port 80 check tcp
}

relay "gopher" {
	listen on egress port 70
	forward to <"gopher"> port 70 check tcp
}

relay "gemini" {
	listen on egress port 1965 tls
	forward to <"gemini"> port 1965 check tcp
}
