# deployed on 2021-05-15

include "/etc/macros.conf"

prefork 5
log connection

table <"http"> { 127.0.0.1 }
table <"gemini"> { 127.0.0.1 }

protocol "tls" {
	include "/etc/relayd/tls.conf"
}

http protocol "http" {
	include "/etc/relayd/tls.conf"

	match request \
	  header append "X-Forwarded-For" value "$REMOTE_ADDR"
	match request \
	  header append "X-Forwarded-By" value "$SERVER_ADDR:$SERVER_PORT"
}

relay "https" {
	listen on egress port 443 tls
	protocol "http"
	forward to <"http"> port 80 check tcp
}

relay "gemini" {
	listen on egress port 1965 tls
	protocol "tls"
	forward to <"gemini"> port 1965 check tcp
}
